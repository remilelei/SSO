# SSO系统设计文档

---

## 1 系统功能

系统命题如下：
>具备注册登录功能
 一个⽤用户只能在⼀一个设备上登录，切换终端登录时，其他已登录的终端会被踢出 
 后台可以根据管理理策略略将已登录设备踢出

总结一下：注册，登录，登录状态的维持与销毁。

## 2 程序设计
这里描述一下程序的思路，并且概括性的说一下个人实现的思想与实现方法。
### 2.1 流程设计
#### 2.1.1 注册
![此处输入图片的描述][1]
这里采用不对称加密的方式，加强了传输本身与敏感信息的安全。流程开始时从后台取到RSA算法的公钥，并保存在本地。后续用户提交用于注册的信息（用户名，密码）时，使用该公钥加密（公钥只能用来加密，无法解密）并把加密的内容提交至后台服务。后台服务得到数据后使用自己的私钥来解密，并把解密的数据存入数据库处理，并对其Mysql账户管理的模式把密码转为MD5值。存储结果经由后台服务转交至客户端。
#### 2.1.2 登录
基本连接方式与注册流程基本相似。作为SSO单点登录系统需要提一下的是,`登录对于客户端有两种方式:  1、用户输入账号密码登录。 2、用户近期输入过账号密码，使用之前的票据登录`。无票据时，用户输入的账号密码信息与设备信息加密提供给后台。后台利用数据库验证账号信息是否正确，如果信息正确的话，结合客户端提供的账号信息、s设备信息以及后台当前系统时间（用来后期计算时候过期），按照一定算法生成票据并反馈给客户端。 后续客户端有票据时，经历需要身份验证的场景只需要提供该票据至后台，后台根据逆向算法从票据中取出账号信息、设备信息与票据生成时间，后台校验利用这三个内容来决定该票据是否有效以及身份验证是否通过。如果不通过，客户端重新进行手动身份验证。
#### 2.1.3 登录状态的变化控制
![此处输入图片的描述][2]
客户端的在线状态本身维护于长连接中，根据长连接建立的请求在服务端抽象维护一个会话层，会话层中每一个会话都保存着用户的唯一索引和设备地址。当服务端收到一个长连接建立请求，并且会话层用有一个会话的用户信息与本次请求的用户信息一致但是设备地址不一致则打断会话中原本的长连接，再根据本次请求来建立新的长连接。
### 2.2 涉及工具
1.后台：据要求，使用RGPC。
2.数据存储：mysql。

## 3 具体实现
### 3.1 后台实现
#### 3.1.1 RSA公私钥
![此处输入图片的描述][3]
#### 3.1.2 票据生成
![此处输入图片的描述][4]
#### 3.1.3 关于长连接
真正实现长连接比较麻烦，包括心跳轮训等开发代价比较大。时间原因，这里先不具体实现了，所幸GRPC提供的双向流通信具有长连接的性质，本次长连接就是用的双向流来做的。
#### 3.1.4 会话管理
![此处输入图片的描述][5]
简单的说：使用Hash表维护一个会话层，针对该表中会话执行我们的状态转化工作。


  [1]: http://chuantu.biz/t6/337/1530450701x-1566657759.png
  [2]: https://image.ibb.co/d6ZB48/image.png
  [3]: https://image.ibb.co/jo8hBo/image.png
  [4]: http://chuantu.biz/t6/337/1530453872x-1566657759.png
  [5]: https://image.ibb.co/mawVxT/image.png